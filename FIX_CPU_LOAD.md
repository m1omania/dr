# Исправление критической нагрузки на CPU

## Проблема
- CPU нагрузка резко выросла до 90%+ при запуске Puppeteer
- Ошибка: "Protocol error (Target.setDiscoverTargets): Target closed"
- Сервер показывает критическую нагрузку (82%)

## Причина
Chrome/Puppeteer потребляет слишком много ресурсов на VPS с ограниченной памятью/CPU.

## Решение 1: Оптимизация кода (уже сделано)

Код обновлен с оптимизациями:
- Добавлены флаги для снижения потребления ресурсов
- Ограничение памяти до 512MB для Chrome
- Обработка закрытия браузера

## Решение 2: Использовать --single-process (если ресурсов мало)

Если у вас VPS с 2GB RAM, добавьте в `.env` на сервере:

```bash
USE_SINGLE_PROCESS=true
```

Это снизит нагрузку, но может быть медленнее.

## Решение 3: Увеличить ресурсы сервера

В панели Jino.ru:
1. Нажмите "Настроить ресурсы" или "Увеличить"
2. Увеличьте RAM до 4GB (рекомендуется)
3. Увеличьте CPU до 2+ ядер

## Решение 4: Оптимизировать использование Puppeteer

### Закрывать браузер после использования
Если браузер не используется, можно закрывать его:

```bash
# В коде уже есть функция closeBrowser()
# Можно вызывать после анализа
```

### Использовать пул браузеров
Можно ограничить количество одновременных браузеров.

## Проверка после исправления

1. Обновите backend на сервере:
```bash
cd /opt/ux-audit/backend
git pull origin main
npm run build
systemctl restart ux-audit-backend
```

2. Проверьте нагрузку CPU в панели Jino.ru

3. Попробуйте проанализировать сайт снова

## Рекомендации

### Для VPS с 2GB RAM:
- Используйте `USE_SINGLE_PROCESS=true` в `.env`
- Рассмотрите увеличение до 4GB RAM

### Для VPS с 4GB+ RAM:
- Текущие настройки должны работать
- Мониторьте нагрузку CPU

## Мониторинг

Следите за нагрузкой CPU в панели Jino.ru:
- Нормальная нагрузка: 10-30%
- Высокая нагрузка: 50-80%
- Критическая нагрузка: 80%+ (нужно увеличить ресурсы)

